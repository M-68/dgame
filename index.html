<html>

<head>
  <title> Metamask Demo </title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://unpkg.com/moralis/dist/moralis.js"></script>
</head> 

<body>

  <button onclick="login()">Login with Metamask</button>

  <script>
    Moralis.initialize("OvIEo8OwtQWP6d2a27DdtSJGgAJD05fbRzIsaRBN"); // Application id from moralis.io admin
    Moralis.serverURL = "https://ieb4i2un5l6y.moralisweb3.com:2053/server"// Server url from moralis.io installation

    var state = {}
    var sprites = []
    var buttonsLocked = {}

    async function login() {
      console.log("Login initialising...");
      var user = await Moralis.Web3.authenticate();
      if(user){ // If user exists & is valid
        console.log(user);
      }
    }

    var config = {
      type: Phaser.AUTO,
      width: 1200,
      height: 700,
      scene: {
        preload: preload,
        create: create,
        update: update
      },
      physics: {
        default: 'arcade',
        arcade: { debug: true }
      }
    };

    var game = new Phaser.Game(config);
    var context;

    function preload ()
    {
      ping();
      context = this;
      context.load.image('background', 'bg.jpg');
    }

    async function create()
    {
      this.wKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W);
      this.aKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A);
      this.sKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S);
      this.dKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D);

      // Wait for game state update
      let query = new Moralis.Query("GameState"); // Game state - where all players are on the map
      let subscription = await query.subscribe();
      query.equalTo("stateType", "globalGameState");
      subscription.on('update', (object) => {
        state = object.get("state");
        console.log(state)
      });

      // get current state
      state = await Moralis.Cloud.run("getState")

      context.add.image(0, 0, 'background').setOrigin(0,0).setScale(1,1);
    }
    
  </script>
</body>

</html>